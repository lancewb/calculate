name: Android Release

on:
  push:
    tags:
      - 'v*'

jobs:
  release:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: gradle

    - name: Grant execute permission for gradlew
      run: chmod +x gradlew

    - name: Build Release APK
      run: ./gradlew assembleRelease

    - name: Sign APK
      # 注意：需要在 GitHub Secrets 中配置签名密钥
      # KEYSTORE_FILE: Base64 编码的 keystore 文件
      # KEYSTORE_PASSWORD: keystore 密码
      # KEY_ALIAS: key 别名
      # KEY_PASSWORD: key 密码
      if: ${{ secrets.KEYSTORE_FILE != '' }}
      run: |
        echo "${{ secrets.KEYSTORE_FILE }}" | base64 -d > release.keystore
        ./gradlew assembleRelease \
          -Pandroid.injected.signing.store.file=$(pwd)/release.keystore \
          -Pandroid.injected.signing.store.password=${{ secrets.KEYSTORE_PASSWORD }} \
          -Pandroid.injected.signing.key.alias=${{ secrets.KEY_ALIAS }} \
          -Pandroid.injected.signing.key.password=${{ secrets.KEY_PASSWORD }}

    - name: Get version from tag
      id: get_version
      run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        files: |
          app/build/outputs/apk/release/app-release.apk
          app/build/outputs/apk/release/app-release-unsigned.apk
        name: Release ${{ steps.get_version.outputs.VERSION }}
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Upload APK Artifact
      uses: actions/upload-artifact@v4
      with:
        name: app-release-${{ steps.get_version.outputs.VERSION }}
        path: app/build/outputs/apk/release/*.apk
